getgenv().CustomSpeed = getgenv().CustomSpeed or {}

if getgenv().CustomSpeed.Enabled then
    getgenv().CustomSpeed.Enabled = false

    if getgenv().CustomSpeed.InputBeganConnection then
        getgenv().CustomSpeed.InputBeganConnection:Disconnect()
        getgenv().CustomSpeed.InputBeganConnection = nil
    end
    if getgenv().CustomSpeed.InputEndedConnection then
        getgenv().CustomSpeed.InputEndedConnection:Disconnect()
        getgenv().CustomSpeed.InputEndedConnection = nil
    end

    if getgenv().CustomSpeed.MovementConnection then
        getgenv().CustomSpeed.MovementConnection:Disconnect()
        getgenv().CustomSpeed.MovementConnection = nil
    end

    getgenv().CustomSpeed.KeysDown = nil

    print("Speed Disabled")

else
    getgenv().CustomSpeed.Enabled = true
    print("[Speed] Enabled")

    local Players = game:GetService("Players")
    local UserInputService = game:GetService("UserInputService")
    local RunService = game:GetService("RunService")

    local LocalPlayer = Players.LocalPlayer
    local CHARACTER = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local HRP = CHARACTER:WaitForChild("HumanoidRootPart")

    local SPEED = 5
    local INTERVAL = 0.03

    local keysDown = {}
    getgenv().CustomSpeed.KeysDown = keysDown

    getgenv().CustomSpeed.InputBeganConnection = UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        if input.KeyCode == Enum.KeyCode.W or input.KeyCode == Enum.KeyCode.A 
        or input.KeyCode == Enum.KeyCode.S or input.KeyCode == Enum.KeyCode.D then
            keysDown[input.KeyCode] = true
        end
    end)

    getgenv().CustomSpeed.InputEndedConnection = UserInputService.InputEnded:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.W or input.KeyCode == Enum.KeyCode.A 
        or input.KeyCode == Enum.KeyCode.S or input.KeyCode == Enum.KeyCode.D then
            keysDown[input.KeyCode] = nil
        end
    end)

    getgenv().CustomSpeed.MovementConnection = RunService.Heartbeat:Connect(function()
        if next(keysDown) ~= nil then
            local direction = Vector3.zero

            if keysDown[Enum.KeyCode.W] then
                direction += HRP.CFrame.LookVector
            end
            if keysDown[Enum.KeyCode.S] then
                direction -= HRP.CFrame.LookVector
            end
            if keysDown[Enum.KeyCode.A] then
                direction -= HRP.CFrame.RightVector
            end
            if keysDown[Enum.KeyCode.D] then
                direction += HRP.CFrame.RightVector
            end

            direction = direction.Unit
            HRP.CFrame = HRP.CFrame + direction * SPEED
        end
    end)
end
